<form class="form_to_add_stuffs">
    <div class="form_card_header">
        <label id="close" onclick="remove_form('form_to_add_card')"><i class="fas fa-close"></i></label>
        <h2 id="Title">Add Table Card</h2>
    </div>
    <div class="form-group">
        <label for="F1">Heading & Position</label>
        <div class="input-group">
            <input type="text" name="headingOfTab" id="F1" placeholder="Enter table heading (e.g., Student Details)" oninput="updatePreviewTab('tablePreview')" class="form-control"/>
            <input type="number" name="containerPosTab" id="containerPosTab" class="form-control" placeholder="Container-Position" style="max-width: 7em" value="0">
        </div>
    </div>
    <div class="form-group">
        <label for="F2">File to Table ( Excel or CSV files )</label>
        <input type="file" accept=".xslx, .csv, .xls" name="fileToTab" id="F2" placeholder="Select a file" oninput="updatePreviewTab('tablePreview', 'F2')" class="form-control" />
    </div>

    <div class="form-group">
        <label for="F9">Enter the Block names ( Fieldsets-legends ) using Enter (â†©) key</label>
        <textarea name="headingsOfFieldsetTab" id="F9" rows="3" placeholder="e.g., School-Student
        College-Student" oninput="generateFieldsets(this.value,'fieldsetsContainerTab')" class="form-control"></textarea>
    </div>
    
    <div id="fieldsetsContainerTab">

    </div>
    <div class="preview-container">
        <h3>Table Preview</h3>
        <div id="tablePreview" class="form-preview">
            <p>Your Table preview will appear here</p>
        </div>
    </div>

    <div class="buttons-group">
        <button type="button" onclick="resetForm('fieldsetsContainerTab')">Reset</button>
        <button type="button" onclick="generateCode('tablePreview', 'Table',  document.getElementById('containerPosTab').value)">Generate table Code</button>
    </div>
</form>
<script >
    let fieldsetsCount =0;
    function generateTbody(values, n) {
        if (values < 0) {
            alert('Number of rows cannot be negative');
            return;
        }

        const cont = document.getElementById('dataContainers'+n);
        const head = document.getElementById('F3'+n);
        const headers = head.value.trim().split(',').filter(h => h); 
    
        if (!cont || !head || headers.length === 0) {
            alert('Please enter headers first!');
            return;
        }

        cont.innerHTML = '';
        for (let i = 1; i <= values; i++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'data-row';
            rowDiv.style.display = 'flex';
            rowDiv.style.gap = '0.8em';

            headers.forEach((header, index) => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-field-sm';
                formGroup.gap = "0.1em"
                
                const label = document.createElement('label');
                label.htmlFor = `table${n}_header${index}_row${i}`;
                label.textContent = `${header.trim()}-${i}`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `table${n}_headerData${index}_row${i}`;
                input.id = `table${n}_header${index}_row${i}`;
                input.placeholder = `Enter ${header.trim()} value`;
                input.oninput = function() {
                    updatePreviewTab('tablePreview');
                };
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                rowDiv.appendChild(formGroup);
            });

            cont.appendChild(rowDiv);
        }
        fieldsetsCount = values;
        updatePreviewTab('tablePreview')
        
    }
    function createDoubleheadedTable(toph, lefth) {
        let tableHtml = "\t<tr>\n\t\t<th></th>";
        for (let i = 0; i < toph.length; i++) {
            tableHtml += `<th>${toph[i]}</th>`;
        }
        tableHtml += "\n\n\t</tr>\n";
        for (let j = 0; j < lefth.length; j++) {
            tableHtml += "\t<tr>\n";
            tableHtml += `\t\t<th>${lefth[j]}</th>`;
            for (let k = 0; k < toph.length; k++) {
                let cellId = `table1_header${k}_row${j+1}`;
                let cellValue = "None";
                let cellInput = document.getElementById(cellId);
                if (cellInput) {
                    cellValue = cellInput.value || 'None';
                }
                tableHtml += `<td>${cellValue}</td>`;
            }
            tableHtml += "\n\t</tr>\n";
        }
        return tableHtml;
    }
    function updatePreviewTab(pContainer, fileInp=null){
        const previewCont = document.getElementById(pContainer)
        const fieldsets = document.getElementById('F9').value.trim().split('\n')
        const tableTitle = document.getElementById('F1').value || 'Title'
        previewCont.innerHTML = ""

        let previewHtml = `<h2 class="text-primary" >${tableTitle}</h2>\n`
        previewCont.innerHTML = previewHtml;
        if (fileInp != null) {
            const inputEl = document.getElementById(fileInp);
            inputEl.onchange = function(e) {  
                const file = e.target.files[0];
                if (!file) {
                    alert("Please select a CSV file!");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const text = event.target.result;
                    const rows = text.trim().split("\n").map(row => row.split(","));
                    
                    let table = "<table border='1'>";
                    rows.forEach(r => {
                        table += "<tr>";
                        r.forEach(cell => {
                            table += `<td>${cell.trim()}</td>`;
                        });
                        table += "</tr>";
                    });
                    table += "</table>";

                    previewCont.innerHTML += table;
                };
                reader.readAsText(file);
            };
        }

        else if(fileInp==null){
            for(let i= 1; i<=fieldsets.length;i++){
                const tableType = document.getElementById(`typeOfTab${i}`).value
                const headers = document.getElementById(`F3${i}`).value.trim().split(',')
                const rows = document.getElementById(`F4${i}`).value
                const footers = document.getElementById(`F5${i}`).value.trim().split(',')
                let tableHtml="";
                    
                tableHtml += `<h5 class="text-secondary" >${fieldsets[i-1]}</h5>\n\t<table class="table table-bordered table-striped table-hover">\n\t`;
                
                if(tableType==='hBoth'){
                    const normalHeaders = document.getElementById(`normal_headers${i}`)
                    const numOfRows = document.getElementById(`numberOfRows${i}`)
                    normalHeaders.style.display = 'none'
                    numOfRows.style.display = 'none'

                    const topHeaders = document.getElementById(`top_headers${i}`)
                    const leftHeaders = document.getElementById(`left_headers${i}`)
                    topHeaders.style.display = 'flex'
                    leftHeaders.style.display = 'flex'
                    const top = document.getElementById(`top${i}`).value.trim().split('\n')
                    const left = document.getElementById(`left${i}`).value.trim().split('\n')

                    tableHtml += `${createDoubleheadedTable(top, left)}`
                }

                if (headers.length > 0) {
                    if (tableType === 'hAtTop') {
                        tableHtml += `\t\t<thead>\n\t\t\t<tr>\n`;
                        for (let a = 0; a < headers.length; a++) {
                            tableHtml += `\t\t\t\t<th>${headers[a]}</th>\n`;
                        }
                        tableHtml += `\t\t\t</tr>\n\t\t</thead>\n`;
                    }
                }

                if (rows) {
                    if (tableType === 'hAtTop') {
                        tableHtml += `\t\t<tbody>\n`;
                        for (let j = 1; j <= rows; j++) {
                            tableHtml += `\t\t\t<tr>\n`;
                            for (let k = 0; k < headers.length; k++) {
                                tableHtml += `\t\t\t\t<td>${document.getElementById(`table${i}_header${k}_row${j}`).value || 'None'}</td>\n`;
                            }
                            tableHtml += `\t\t\t</tr>\n`;
                        }
                        tableHtml += `\t\t</tbody>\n`;
                    }

                    if (tableType === 'hAtLeft') {
                        for (let k = 0; k < headers.length; k++) {
                            tableHtml += `\t\t\t<tr>\n`;
                            tableHtml += `\t\t\t\t<th>${headers[k]}</th>\n`;
                            for (let j = 1; j <= rows; j++) {
                                tableHtml += `\t\t\t\t<td>${document.getElementById(`table${i}_header${k}_row${j}`).value || 'None'}</td>\n`;
                            }
                            tableHtml += `\t\t\t</tr>\n`;
                        }
                    }
                }

                if (footers.length > 0 && footers) {
                    tableHtml += `\n\t\t<tfoot>\n\t\t\t<tr>\n`;
                    for (let h = 0; h < footers.length; h++) {
                        tableHtml += `\t\t\t\t<td>${footers[h]}</td>\n`;
                    }
                    tableHtml += `\t\t\t</tr>\n\t\t</tfoot>\n`;
                }

                tableHtml += "\t</table>"
                tableHtml = `\t<div class='table-responsive'>\n\t${tableHtml}\n</div>\n`;

                previewCont.innerHTML += tableHtml;
            }
        }
    }
    function generateCode(pCont, element,pos,file=null){
        remove_form('form_to_add_card');
        const previewCont = document.getElementById(pCont);
        let code = previewCont.innerHTML;

        code = `\n<div class='${pos} container'>\n\t${code}\n</div>\n`;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = code;
        const formattedCode = tempDiv.innerHTML;

        previewCont.innerHTML = "";
        const form = document.getElementById('implementCodeFormCont');
        const texta = document.getElementById("MainCode");
        form.style.display = 'flex';
        texta.value = formattedCode;

    }
</script>