<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="shortcut icon" href="../static/favicon/{{all['favicon'][0]}}" type="image/x-icon" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
		<link rel="stylesheet" href="../static/adminPanel.css">
		<link rel="stylesheet" href="../static/flash-messages.css">
		<title>WebPersona-Admin Pannel</title>
		<script>
			function showMessage(message, type) {
				const flashContainer = document.createElement('div');
				flashContainer.className = `alert alert-${type}`;
				flashContainer.textContent = message;
				
				const messagesContainer = document.querySelector('.messages') || document.body;
				messagesContainer.appendChild(flashContainer);
				
				setTimeout(() => {
					flashContainer.remove();
				}, 5000);
			}
			
			function saveBlock(fileName, blockId, divId) {
				const iframe = document.getElementById('Iframe');
				const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
				const html = iframeDoc.getElementById(divId).innerHTML.split('\n').filter(line => line !== '').map(line => line + '\n');
				
				fetch('/save-block-multi', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						file: fileName,
						block: blockId,
						html: html
					})
				})
				.then(response => response.json())
				.then(data => {
					const messageType = data.status === 'success' ? 'success' : 'danger';
					showMessage(data.message, messageType);
				})
				.catch(error => {
					showMessage('Error saving content: ' + error.message, 'danger');
				});
			}
		</script>	
		<script>
			function toVarName(inputId, old, New){
				const inputs = document.getElementsByClassName(inputId);
				for(const input of inputs){
					input.value = input.value.replace(old, New)
					input.value = input.value.replace(/[^a-zA-Z0-9_]/g, '');
					if (/^[0-9]/.test(input.value)) {
						input.value = input.value.replace(/^[0-9]+/, ''); 
					}
				}
    		}
			document.addEventListener("DOMContentLoaded", function () {
				const iframe = document.getElementById("Iframe");

				if (iframe) {  
					iframe.onload = function () {
					const debug = iframe.dataset.debug === "true";

					if (debug) {
						try {
						const doc = iframe.contentDocument || iframe.contentWindow.document;
						const html = doc.documentElement.outerHTML;

						const escaped = html
							.replace(/</g, "&lt;")
							.replace(/>/g, "&gt;");

						doc.body.innerHTML = `<pre style="
							white-space: pre-wrap;
							font-family: monospace;
							padding: 1rem;
							background: #1e1e2f;
							color: #f8f8f2;
							font-size: 0.8rem;
							line-height: 1.2;
							overflow: auto;
						">${escaped}</pre>`;
						} catch (err) {
						console.error("Debug Mode failed to read iframe source:", err);
						}
					}
					};
				} else {
					console.warn('⚠️ No element with id="Iframe" found.');
				}
			});
		</script> 
	</head>
	<body>
		{% with messages = get_flashed_messages(with_categories=true) %}
		  {% if messages %}
			<div id="flashed-messages">
			  {% for category, message in messages %}
				<div class="flash-message flash-{{ category }}">
				  <span class="flash-icon">{% if category == 'success' %}✔️{% elif category in ['error', 'danger'] %}❌{% elif category == 'info' %}ℹ️{% else %}⚠️{% endif %}</span>
				  <span class="flash-text">{{ message }}</span>
				</div>
			  {% endfor %}
			</div>
			<script>
				window.addEventListener('DOMContentLoaded', function() {
					setTimeout(function() {
						var flashes = document.getElementById('flashed-messages');
						if (flashes) {
							flashes.style.transition = 'opacity 0.5s';
							flashes.style.opacity = '0';
							setTimeout(function() {
								flashes.style.display = 'none';
							}, 800);
						}
					}, 2500);
				});
			</script>
		  {% endif %}
		{% endwith %}
		<div id="implementCodeFormCont" class="implementCodeCont">
			<div id="implementCodeForm" >
				<div class="form_card_header">
					<label id="close" onclick="remove_form('implementCodeCont')"><i class="fas fa-close"></i></label>
					<h2 id="Title">Code Implementation</h2>
				</div>
				<form action='/implement' method='GET'>
					<div class='form-group'>
						<label for='MainCode'>Code to implement element </label>
						<textarea name='mainCode' id='MainCode' cols="50" rows='20'></textarea>
					</div>
					<div class='buttons-group'>
						<button type="button" onclick="remove_form('implementCodeCont')">Cancel</button>
						<button type='submit'>Implement</button>
					</div>
				</form>
			</div>
		</div>
		{% if all['body_content_editable'] %}
		<div class="form_to_add_card" id="add_form_card" >{% include 'Forms/Form_to_add_form.html' %}</div>
		<div class="form_to_add_card" id="add_table_card">{% include 'Forms/Form_to_add_table.html' %}</div>
		<div class="form_to_add_card" id="add_blog_card" >{% include 'Forms/Form_to_add_blog.html'%}</div>
		<div class="form_to_add_card" id="add_list_card" >{% include 'Forms/Form_to_add_list.html' %}</div>
		<div class="form_to_add_card" id="add_iframe_card" >{% include 'Forms/Form_to_add_iframe.html' %}</div>
		<div class="form_to_add_card" id="add_grid_card" >{% include 'Forms/Form_to_add_grid.html' %}</div>
		<div class="form_to_add_card" id="add_link_card" >{% include 'Forms/Form_to_add_link.html' %}</div>


		<div class="editer_tool_wrapper">
			<div class="tools">
				<label for="" data-name="Form" onclick="show_form('add_form_card')"><i class="fas fa-file-text" aria-hidden="true" title="Add Form" ></i><i class="fa-solid fa-circle-plus"></i></label>
				<label for="" onclick="show_form('add_table_card')"><i class="fa fa-table" aria-hidden="true" title="Add tabel"></i><i class="fa-solid fa-circle-plus"></i> </label>
				<label for="Blogg" onclick="show_form('add_blog_card')"><i class="fa-brands fa-blogger-b"></i><i class="fa-solid fa-circle-plus"></i></label>
				<label for=""  onclick="show_form('add_list_card')"><i class="fa-solid fa-list"></i><i class="fa-solid fa-circle-plus"></i></label>
				<label for="" onclick="show_form('add_iframe_card')"><i class="fa-regular fa-file-code"></i><i class="fa-solid fa-circle-plus"></i></label>
				<label for="grid" title="Add grids" onclick="show_form('add_grid_card')" ><i class="fas fa-grip"></i><i class="fa-solid fa-circle-plus"></i></label>
				<label for="link" title="Add links" onclick="show_form('add_link_card')"><i class="fa-solid fa-link"></i><i class="fa-solid fa-circle-plus"></i></label>
			</div>
			<button type="button" id="saveEditedButton"  onclick="saveBlock('{{web.previewPage}}', '{{web.previewPage}}', '{{web.previewPage}}')" >Save the edited</button>
			
			<script>
				function show_form(id){
					const form = document.getElementById(id);
					if (!form) return;
					
					// Toggle the display
					if (form.style.display === 'none' || form.style.display === '') {
						form.style.display = 'flex';
					} else {
						form.style.display = 'none';
					}
				}
				function remove_form(id){
					const form = document.getElementsByClassName(id)
					for(let i =0; i<form.length; i++){
						form[i].style.display = 'none'
					}
				}
			</script>
		</div>
		{% else %}
		{%endif%}
		<nav>
			<h1><i class="fas fa-home"></i>Control Panel</h1>
			<ul type ='none'>
				<li>
					<label for="whichSection">You are on</label>
					<select id="whichSection" >
						<option value=""><a href="#the_web" >Website</a></option>
						<option value=""><a href="#the_web">Database</a></option>
						<option value=""><a href="#the_web">others</a></option>
					</select>
				</li>
				<li>
					<details>
						<summary>FAQs</summary>
						<div>hii</div>
					</details>
				</li>
				<li>
					<details>
						<summary>Help</summary>
					</details>
				</li>
				<li>
					<details>
						<summary>Contect</summary>
					</details>
				</li>
				<li>
					<form action="/Debug-mode" method="POST" id="debugModeForm" >
						{% if web.debugMode %}
						<input type="checkbox" name="debugMode" id="debugging" onchange="this.form.submit()" checked />
						{%else%}
						<input type="checkbox" name="debugMode" id="debugging"  onchange="this.form.submit()" />
						{%endif%}
	
						<label for="debugging">Debug Mode</label>
						<script>
							function debugPage(page, out){
								alert(page)
								fetch(page)
									.then(response => response.text())
									.then(data => {
										alert(data); // HTML as string
										document.getElementById(out).innerHTML = data; // inject into page
									});
							}
						</script>
					</form>
				</li>
			</ul>
		</nav>
		<section id="the_web">
			<div id="page_containers" >
				<h1>Pages</h1>
				<div id="containers_list">
					{% for page in all['pages'] %}
						{% if page not in all['unviewPages'] %} 
						<details id="favicons_container" class="{{'highlight' if page==all['previewPage'] else 'none'}}">
							<summary >
								{{page.removesuffix('.html')}} 
								<form action="/delete-change-Favicon-page" method="post" enctype="multipart/form-data" id="edit_favicon" >
								{% if page not in all['unremovablePages'] %}
									<label for="del{{page}}" title="Delete the Page"><i class="fas fa-trash-alt"></i></label>
									<input type="submit" id="del{{page}}" name="delete_page" value="{{page}}" />
								{% endif %}
									<label for="view{{page}}" title="Preview Page"><i class="fas fa-eye"></i></label>
									<input type="submit" id="view{{page}}" name="preview_page" value="{{page}}" />
								</form>
							</summary>
						</details>
						{%endif%}
					{% endfor %} 
					{% for folder in all['folderDict'].keys() %}
					<details open="True">
						<summary>{{folder}}<i class="fa fa-angle-down"></i></summary>
						{% for page in all['folderDict'][folder] %}
						<details style="width: 90%; float:inline-end; border: none; margin: 0; padding: 0.5em;" class="{{'highlight' if page==all['previewPage'] else 'none'}}">
							<summary>
								{{page.removesuffix('.html')}}
								<form action="/delete-change-Favicon-page" method="post" enctype="multipart/form-data" id="edit_favicon" >
									{% if folder == "Header_pages" %}
										<label for="del{{page}}" title="Delete Page"><i class="fas fa-trash-alt"></i></label>
										<input type="submit" id="del{{page}}" name="delete_page" value="{{folder}}/{{page}}" />
									{% endif %}
									<label for="view{{page}}" title="Preview Page"><i class="fas fa-eye"></i></label>
									<input type="submit" id="view{{page}}" name="preview_page" value="{{page}}" />
								</form>
							</summary>
						</details>
						{% endfor %}
					</details>
					{% endfor %}
				</div>
			</div>
			<div id="preview_container">
				<div id="previewContainerHeader" class="container_headers">
					<h1>Your Website</h1>
					<form action="/frameSizeChange" method="post" enctype="multipart/form-data" id="frameSizeForm">
						<details id="resolutions">
							<summary>Resolutions</summary>
							<ul type="none" id="resolutionList">
								{% for size in all['sizes'] %}
									<li><input type="submit" value="{{ size}}" name="frame_size"></li>
								{% endfor %}
								<li>
									<input type="number" name="frame_size" id="new_frame_size" style="background: #2c3e5020; width: 70px;" placeholder="912" />
									<button type="submit"><i class="fas fa-add"></i></button >
								</li>
							</ul>
						</details>
					</form>
				</div>
				<div id="frameContainer">
					{% if web.debugMode %}
					<form action="">
						<textarea name="changedCode" id="debugTextareaCode" row="150" colum>
							{% for line in web.previewPageHtml %}
								{{line}}
							{%endfor%}
						</textarea>
						<button type='submit'>Apply</button>
					</form>
					{%endif%}
					<iframe src="{{ all['previewPage']}}" width="{{ all['size'] }}" height="100%" 
					style="display: block; margin: auto; border: none;" id="Iframe" ></iframe>
				</div>
			</div>
			<div id="feature_list">
				<h1>Features</h1>
				{% if web.previewPage == 'header.html' %}
					<div class="features" id="addNavigation" >
						<h3><i class="fas fa-compass" title="Add New Page"></i>Add Navigations</h3>
						<form action="/Addition" method="POST" enctype="multipart/form-data" style="margin-top: 1em">
							<input type="text" name="navigationText" id="navigationText" placeholder="Text" required>
							
							<input type="number" name="navigationTextPos" id="navigationTextPos" placeholder="Position" >
	
							<div class="form-groups">
								<label for="navigationText">Select the page to navigate</label>
								<select name="navigationPage" id="navigationPage" style="width: 100%;" onchange="this.form.submit()">
									<option value="none">None</option>
									{% for page in all['pages'] %}
										{% if page not in all['unviewPages'] %} 
										<option value='{{page}}' >{{page}}</option>
										{% endif %}
									{% endfor %}
								</select>
							</div>
						</form>
					</div>
					{% for nav in all['navigation'] %}
						<div id="favicons_container">
							<p>{{nav['name']}}</p>
							<form action="/Deletion" method="post" enctype="multipart/form-data" id="edit_favicon">
								<label for="del{{nav}}" title="Remove the navigation"><i class="fas fa-trash-alt"></i></label>
								<input type="submit" id="del{{nav}}" name="delete_navigation" value="{{nav['name']}}" />
							</form>
						</div>
					{% endfor %}
				{% endif %}
				<div class="features" id="addPage">
					<h3><i class="fas fa-file-alt" title="Add New Page"></i>Add New page</h3>
					<form action="/Addition" method="POST" enctype="multipart/form-data" style="margin-top: 1em" >
						<input type="text" name="fileName" class="filName" placeholder="Page name" oninput="toVarName(this.className, ' ', '_')"/>
						<input type="text" name="title" id="fileTitle" placeholder="Page title" />
						<div class="form-groups">
							<label for="htmlfile">Put your own logic or template</label>
							<input type="file" name="ownHtml" id="htmlfile" accept=".html, .htm, .py" placeholder="Put your File" />
						</div>
						<div id="addPageButtons">
							<button type="reset">reset</button>
							<button type="submit">Add</button>
						</div>
					</form>
				</div>
				<div class="features">
					<h3><i class="fas fa-images" title="Add Logo / Favicon"></i>Add Pictures</h3>
					<div style="max-height: 8em;overflow: auto;">
						{% for icon in all['favicons'] %}
						<div id="favicons_container">
							<img src="../static/favicons/{{icon}}" alt="icon" />
							<p>{{icon}}</p>
							<form action="/delete-change-Favicon-page" method="post" enctype="multipart/form-data" id="edit_favicon">
								<label for="del{{icon}}" title="Remove the image"><i class="fas fa-trash-alt"></i></label>
								<input type="submit" id="del{{icon}}" name="delete_favicon" value="{{icon}}" />
								<label for="ch{{icon}}" title="Set as Favicon"><i class="fas fa-star"></i></label>
								<input type="submit" id="ch{{icon}}" name="change_favicon" value="{{icon}}"/>
								<label for="logo{{icon}}" title="Set as Logo"><i class="fas fa-plus-circle"></i></label>
								<input type="submit" id="logo{{icon}}" name="change_logo" value="{{icon}}" />
								<label for="img{{icon}}" title="Set image to page"><i class="fas fa-file-image" a></i></label>
								<input type="submit" id="img{{icon}}" name="set_to_page" value="{{icon}}"/>
							</form>
						</div>
						{% endfor %}
					</div>
					<form
						action="/faviconAddition"
						method="post"
						enctype="multipart/form-data"
					>
						<input type="file" name="icon_path" id="Favicon" accept="image/*" />

						<button type="submit">Add</button>
					</form>
				</div>
				<div  class ="features" id="EditContent">
					<h3><i class="fas fa-pen-to-square" title="Edit Page"></i>Make Page Editable</h3>
					<form action="/Content-editable" method="post" enctype="multipart/form-data" class="content_edit">
						{% if all['body_content_editable']==False %}
						<input type="checkbox" name="contentEditable" id="Content_editable" onchange="this.form.submit()" />
						{% else %}
						<input type="checkbox" name="contentEditable" id="Content_editable" onchange="this.form.submit()" checked/>
						{% endif %}
						<label for="Content_editable">Content Editable</label>
					</form>
					{% if all['body_content_editable'] %} 
					<span style="font-size: xx-small; float: inline-end; color:rgba(255, 0, 0, 0.71)"><i class="fas fa-info-circle"></i> Off Before Leaving!</span>
					{% else %} {% endif %}
				</div>
				<div class="features" id="color">
					<h3><i class="fas fa-palette" title="Choose Theme"></i>Choose Theme</h3>
					<form action="/theme-rotate" method="post" enctype="multipart/form-data">
						<button type="submit" name="change_theme" value="left" class="theme-btn">
							<i class="fa fa-angle-left"></i>
						</button>

						<h4>{{ all['themes'][-19:][0].removesuffix('*/\n').removeprefix('/*') }}</h4>

						<button type="submit" name="change_theme" value="right" class="theme-btn">
							<i class="fas fa-angle-right"></i>
						</button>
					</form>
				</div>
				
			</div>
		</section>
	</body>
</html>