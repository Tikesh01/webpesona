<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="shortcut icon" href="../static/favicon/{{all['favicon'][0]}}" type="image/x-icon" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
		<link rel="stylesheet" href="../static/adminPanel.css">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
		<title>WebPersona-Admin Pannel</title>
		<script>
			function saveBlock(fileName, blockId, divId) {
				if(confirm('Are you sure!')){
					const iframe = document.getElementById('Iframe');
					const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
					const html = iframeDoc.getElementById(divId).innerHTML.split('\n').filter(line => line !== '').map(line => line + '\n');
					
					fetch('/save-block-multi', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							file: fileName,
							block: blockId,
							html: html
						})
					})
					.then(response => response.json())
					.then(data => {
						const messageType = data.status === 'success' ? 'success' : 'danger';
						showMessage(data.message, messageType);
					})
					.catch(error => {
						showMessage('Error saving content: ' + error.message, 'danger');
					});
				}
			}
		</script>	
		<script>
			function toVarName(inputId, old, New){
				const inputs = document.getElementsByClassName(inputId);
				for(const input of inputs){
					input.value = input.value.replace(old, New)
					input.value = input.value.replace(/[^a-zA-Z0-9_]/g, '');
					if (/^[0-9]/.test(input.value)) {
						input.value = input.value.replace(/^[0-9]+/, ''); 
					}
				}
    		}
			function writeToPage(code, pageNameId){
				const iframe = document.getElementById('Iframe');
				const iframeDoc = iframe.contentWindow.document;
				largeContainer = iframeDoc.getElementById(pageNameId)
				
				largeContainer.innerHTML += code;
				alert(largeContainer.innerHTML)
				
				saveBlock(pageNameId, pageNameId, pageNameId);
			}
		</script> 
	</head>
	<body>
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3 message" style="z-index: 1080">
				{% for category, message in messages %}
					<div class="toast align-items-center text-bg-{{ 'success' if category == 'success' else 'danger' if category in ['error', 'danger'] else 'info' if category == 'info' else 'warning' }} border-0 mb-2 show" role="alert" aria-live="assertive" aria-atomic="true">
					<div class="d-flex">
						<div class="toast-body d-flex align-items-center gap-2">
						{% if category == 'success' %}
							<i class="fas fa-check-circle text-light"></i>
						{% elif category in ['error', 'danger'] %}
							<i class="fas fa-times-circle text-light"></i>
						{% elif category == 'info' %}
							<i class="fas fa-info-circle text-light"></i>
						{% else %}
							<i class="fas fa-exclamation-triangle text-light"></i>
						{% endif %}
						<span>{{ message }}</span>
					</div>
						<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
					</div>
					</div>
				{% endfor %}
				</div>
				<script>
					document.addEventListener('DOMContentLoaded', function() {
						const toasts = document.querySelectorAll('.toast');
						toasts.forEach(toastEl => {
						const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
						bsToast.show();
						});
					});
				</script>
			{% endif %}
		{% endwith %}

		<div id="implementCodeFormCont" class="implementCodeCont">
			<div id="implementCodeForm" >
				<div class="form_card_header">
					<label id="close" onclick="remove_form('implementCodeCont')"><i class="fas fa-close"></i></label>
					<h2 id="Title">Code Implementation</h2>
				</div>
				<form >
					<div class='form-group'>
						<label for='MainCode'>Code to implement element </label>
						<textarea name='mainCode' id='MainCode' cols="50" rows='20'></textarea>
					</div>
					<div class='buttons-group'>
						<button type="button" onclick="remove_form('implementCodeCont')">Cancel</button>
						<button type='button' onclick="writeToPage(document.getElementById('MainCode').value, '{{web.previewPage}}')">Implement</button>
					</div>
				</form>
			</div>
		</div>
		{% if all['body_content_editable'] %}
		<div class="form_to_add_card" id="add_form_card" >{% include 'Forms/Form_to_add_form.html' %}</div>
		<div class="form_to_add_card" id="add_table_card">{% include 'Forms/Form_to_add_table.html' %}</div>
		<div class="form_to_add_card" id="add_blog_card" >{% include 'Forms/Form_to_add_blog.html'%}</div>
		<div class="form_to_add_card" id="add_list_card" >{% include 'Forms/Form_to_add_list.html' %}</div>
		<div class="form_to_add_card" id="add_iframe_card" >{% include 'Forms/Form_to_add_iframe.html' %}</div>
		<div class="form_to_add_card" id="add_grid_card" >{% include 'Forms/Form_to_add_grid.html' %}</div>
		<div class="form_to_add_card" id="add_link_card" >{% include 'Forms/Form_to_add_link.html' %}</div>

		<div class="editor-toolbar-wrapper">
			<div class="btn-toolbar" role="toolbar" aria-label="Editor toolbar">
				<div class="btn-group me-2" role="group" aria-label="Add elements group">
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Form" onclick="show_form('add_form_card')"><i class="fa-solid fa-file-alt"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Table" onclick="show_form('add_table_card')"><i class="fas fa-table"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Blog/Content" onclick="show_form('add_blog_card')"><i class="fab fa-blogger-b"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add List" onclick="show_form('add_list_card')"><i class="fas fa-list"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Iframe" onclick="show_form('add_iframe_card')"><i class="far fa-file-code"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Grids" onclick="show_form('add_grid_card')"><i class="fas fa-th"></i></button>
					<button type="button" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Add Link" onclick="show_form('add_link_card')"><i class="fas fa-link"></i></button>
				</div>
				<div class="btn-group" role="group" aria-label="Save group">
					<button type="button" class="btn btn-success" onclick="saveBlock('{{web.previewPage}}', '{{web.previewPage}}', '{{web.previewPage}}')" ><i class="fas fa-save me-2"></i>Save Changes</button>
				</div>
			</div>
			<script>
				const allForms = document.querySelectorAll('.form_to_add_card');

				function show_form(targetId) {
					const targetForm = document.getElementById(targetId);
					if (!targetForm) return;

					const isVisible = targetForm.style.display === 'flex';

					// Hide all forms first
					allForms.forEach(form => form.style.display = 'none');

					// If the target form was not visible, show it
					if (!isVisible) {
						targetForm.style.display = 'flex';
					}
				}

				function remove_form(className) {
					const forms = document.getElementsByClassName(className);
					for (let i = 0; i < forms.length; i++) {
						forms[i].style.display = 'none';
					}
				}

				// Initialize Bootstrap tooltips
				document.addEventListener('DOMContentLoaded', function () {
					const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
					const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
						return new bootstrap.Tooltip(tooltipTriggerEl);
					});
				});
			</script>
		</div>
		{% else %}
		{% endif %}

	
		<nav class="navbar navbar-expand-lg" style="border-bottom:0.5px solid rgba(128, 128, 128, 0.4);">
			<div class="container-fluid">
				<a class="navbar-brand" href="#"><i class="fas fa-cogs me-2"></i>Control Panel</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto" style="gap: 1em;">
						<li class="nav-item dropdown">
							<div class="dropdown-center" id="framesizeDropdown">
								<a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
									Resolutions
								</a>

								<ul class="dropdown-menu p-3" style="min-width: 220px;">
									<form action="/frameSizeChange" method="post" enctype="multipart/form-data" id="sizelist" >
									{% for size in all['sizes'] %}
										<li>
										<button type="submit" name="frame_size" value="{{size}}" class="btn btn-sm btn-outline-primary w-100">
											{{ size }}
										</button>
										</li>
									{% endfor %}
									
									<li >
										<div class="input-group input-group-sm">
											<input type="number" name="frame_size" class="form-control" placeholder="912" style="width: 2.5em;"/>
											<button class="btn btn-success" type="submit">
												<i class="fas fa-plus"></i>
											</button>
										</div>
									</li>
									</form>
								</ul>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								Resources
							</a>
							<ul class="dropdown-menu dropdown-menu-dark">
								<li><a class="dropdown-item" href="#">FAQs</a></li>
								<li><a class="dropdown-item" href="#">Help</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="#">Contact</a></li>
							</ul>
						</li>
						<li class="nav-item">
							<a href="/logout" class="nav-link text-danger">
								<i class="fas fa-sign-out-alt me-1"></i>Logout
							</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<section id="the_web">
			<div id="page_containers">
				<div class="container-header mb-3">
					<!-- <h1 class="mb-0"><i class="fas fa-file-alt me-2"></i>Pages</h1> -->
					<div class="input-group input-group-sm mt-2">
						<span class="input-group-text" id="search-addon"><i class="fas fa-search"></i></span>
						<input type="text" class="form-control" id="pageSearch" placeholder="Search pages..." aria-label="Search pages" aria-describedby="search-addon">
					</div>
				</div>
				<div class="list-group" id="pagesList">
					{% for page in all['pages'] %}
						{% if page not in all['unviewPages'] %}
						<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center page-item {{'active' if page==all['previewPage']}}">
							<span class="page-name">{{page.removesuffix('.html')}}</span>
							<form action="/delete-change-Favicon-page" method="post" class="d-inline-flex gap-2">
								<button type="submit" name="preview_page" value="{{page}}" class="btn btn-sm p-0 px-2 btn-outline-primary" title="Preview Page"><i class="fas fa-eye"></i></button>
								{% if page not in all['unremovablePages'] %}
								<button type="submit" name="delete_page" value="{{page}}" class="btn btn-sm p-0 px-2 btn-outline-danger" title="Delete Page"><i class="fas fa-trash-alt"></i></button>
								{% endif %}
							</form>
						</div>
						{% endif %}
					{% endfor %}
					{% for folder in all['folderDict'].keys() %}
						<div class="list-group-item folder-header" data-bs-toggle="collapse" data-bs-target="#folder-{{folder}}" aria-expanded="true" aria-controls="folder-{{folder}}">
							<strong>{{folder}}</strong>
							<i class="fas fa-chevron-down float-end"></i>
						</div>
						<div class="collapse show" id="folder-{{folder}}">
							<div class="list-group list-group-flush ps-3">
								{% for page in all['folderDict'][folder] %}
								<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center page-item {{'active' if page==all['previewPage']}}">
									<span class="page-name">{{page.removesuffix('.html')}}</span>
									<form action="/delete-change-Favicon-page" method="post" class="d-inline-flex gap-2">
										<button type="submit" name="preview_page" value="{{page}}" class="btn btn-sm p-0 px-2 btn-outline-primary" title="Preview Page"><i class="fas fa-eye"></i></button>
										{% if folder != "partials" %}
										<button type="submit" name="delete_page" value="{{folder}}/{{page}}" class="btn btn-sm p-0 px-2 btn-outline-danger" title="Delete Page"><i class="fas fa-trash-alt"></i></button>
										{% endif %}
									</form>
								</div>
								{% endfor %}
							</div>
						</div>
					{% endfor %}
				</div>
				<script>
					document.getElementById('pageSearch').addEventListener('keyup', function() {
						let filter = this.value.toLowerCase();
						let items = document.querySelectorAll('#pagesList .page-item');
						items.forEach(function(item) {
							let text = item.querySelector('.page-name').textContent.toLowerCase();
							if (text.includes(filter)) {
								item.style.display = 'flex';
							} else {
								item.style.display = 'none';
							}
						});
					});
				</script>
			</div>
			<div id="preview_container">
				<div id="frameContainer" style="border-top: 0.5px solid rgba(128, 128, 128, 0.39);">
					{% if web.debugMode %}
					<form action="">
						<textarea name="changedCode" id="debugTextareaCode" row="150" colum>
							{% for line in web.previewPageHtml %}
								{{line}}
							{%endfor%}
						</textarea>
						<button type='submit'>Apply</button>
					</form>
					{%endif%}
					<iframe src="{{ all['previewPage']}}" width="{{ all['size'] }}" height="100%" 
					style="display: block; margin: auto; border:0.5px solid rgba(128, 128, 128, 0.4)" id="Iframe" ></iframe>
				</div>
			</div>
			<div id="feature_list">
				<!-- <div class="container-header mb-3">
					<h1 class="mb-0"><i class="fas fa-star me-2"></i>Features</h1>
				</div> -->
				{% if web.previewPage == 'header.html' %}
					<div class="features" id="addNavigation">
						<p>
							<button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#addNavCollapse" aria-expanded="false" aria-controls="addNavCollapse">
								<i class="fas fa-compass"></i> Add Navigation
							</button>
						</p>
						<div class="collapse" id="addNavCollapse">
							<div class="card card-body">
								<form action="/navigation_addition" method="POST" enctype="multipart/form-data">
									<div class="input-group mb-2">
										<input type="text" name="navigationText" id="navigationText" class="form-control form-control-sm" placeholder="Text" required>
										<input type="number" name="navigationTextPos" id="navigationTextPos" class="form-control form-control-sm" placeholder="Pos" style="max-width: 60px;">
									</div>
									<div class="mb-3">
										<label for="navigationPage" class="form-label">Select page to navigate</label>
										<select name="navigationPage" id="navigationPage" class="form-select form-select-sm" onchange="this.form.submit()">
											<option value="none">None</option>
											{% for page in all['pages'] %}
												{% if page not in all['unviewPages'] %} 
												<option value='{{page}}'>{{page}}</option>
												{% endif %}
											{% endfor %}
										</select>
									</div>
								</form>
								<ul class="list-group">
									{% for nav in all['navigation'] %}
										<li class="list-group-item list-group-item-sm d-flex justify-content-between align-items-center">
											<span>{{nav['name']}} <small class="text-muted">({{nav['value']}})</small></span>
											<form action="/Deletion" method="post" class="d-inline">
												<button type="submit" name="delete_navigation" value="{{nav['name']}}" class="btn btn-danger btn-sm p-0 px-2" aria-label="Remove navigation item">
													<i class="fas fa-trash-alt"></i>
												</button>
											</form>
										</li>
									{% endfor %}
								</ul>
							</div>
						</div>
					</div>
				{% endif %}
				<div class="features" id="addPage">
					<p>
						<button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#addPageCollapse" aria-expanded="false" aria-controls="addPageCollapse">
							<i class="fas fa-file-alt"></i> Add New Page
						</button>
					</p>
					<div class="collapse" id="addPageCollapse">
						<div class="card card-body">
							<form action="/page_addition" method="POST" enctype="multipart/form-data">
								<input type="text" name="fileName" class="filName form-control form-control-sm mb-2" placeholder="Page name (e.g., about_us)" oninput="toVarName(this.className, ' ', '_')"/>
								<input type="text" name="title" id="fileTitle" class="form-control form-control-sm mb-2" placeholder="Title (e.g., about-webpersona)" />
								<div id="addPageButtons" class="d-flex justify-content-end gap-2">
									<button type="reset" class="btn btn-outline-secondary btn-sm">Reset</button>
									<button type="submit" class="btn btn-primary btn-sm">Add</button>
								</div>
								<hr>
								<label for="htmlfile" class="form-label">Own logic or template:</label>
								<div class="input-group input-group-sm">
									<input type="file" name="ownHtml" id="htmlfile" class="form-control form-control-sm" accept=".html, .htm, .py" />
									<button type="submit" class="btn btn-primary btn-sm">Upload</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<div class="features">
					<p>
						<button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#addPicturesCollapse" aria-expanded="false" aria-controls="addPicturesCollapse">
							<i class="fas fa-images"></i> Manage Pictures
						</button>
					</p>
					<div class="collapse" id="addPicturesCollapse">
						<div class="card card-body">
							{% for icon in all['images'] %}
								<div class="d-flex align-items-center mb-2">
									<img src="../static/images/{{icon}}" alt="icon" style="width: 24px; height: 24px; object-fit: contain; margin-right: 8px;" />
									<p class="mb-0 me-auto" style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{icon}}</p>
									<form action="/delete-change-Favicon-page" method="post" class="d-inline-flex gap-1" id="edit_favicon_{{loop.index}}">
										<button type="submit" name="delete_favicon" value="{{icon}}" class="btn btn-outline-danger btn-sm p-0 px-1" title="Remove the image"><i class="fas fa-trash-alt"></i></button>
										<button type="submit" name="change_favicon" value="{{icon}}" class="btn btn-outline-secondary btn-sm p-0 px-1" title="Set as Favicon"><i class="fas fa-star"></i></button>
										<button type="submit" name="change_logo" value="{{icon}}" class="btn btn-outline-secondary btn-sm p-0 px-1" title="Set as Logo"><i class="fas fa-plus-circle"></i></button>
										<button type="submit" name="set_to_page" value="{{icon}}" class="btn btn-outline-secondary btn-sm p-0 px-1" title="Set image to page"><i class="fas fa-file-image"></i></button>
									</form>
								</div>
							{% endfor %}
							<hr>
							<form action="/faviconAddition" method="post" enctype="multipart/form-data">
								<div class="input-group input-group-sm">
									<input type="file" name="icon_path" id="Favicon" class="form-control form-control-sm" accept="image/*" />
									<button type="submit" class="btn btn-primary btn-sm">Upload</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<div class="features">
					<p>
						<button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#chooseThemeCollapse" aria-expanded="false" aria-controls="chooseThemeCollapse">
							<i class="fas fa-palette"></i> Choose Theme
						</button>
					</p>
					<div class="collapse" id="chooseThemeCollapse">
						<div class="card card-body">
							<form action="/theme-rotate" method="post" class="d-flex justify-content-between align-items-center">
								<button type="submit" name="change_theme" value="left" class="btn btn-outline-secondary btn-sm">
									<i class="fa fa-angle-left"></i>
								</button>
								<span class="mx-2 text-center">{{ all['themes'][-19:][0].removesuffix('*/\n').removeprefix('/*') }}</span>
								<button type="submit" name="change_theme" value="right" class="btn btn-outline-secondary btn-sm">
									<i class="fas fa-angle-right"></i>
								</button>
							</form>
						</div>
					</div>
				</div>
				<div class="features" id="EditContent">
					<form action="/Content-editable" method="post" class="form-check form-switch bg-light border rounded p-2 ps-5">
						<input class="form-check-input" type="checkbox" role="switch" id="Content_editable" name="contentEditable" onchange="this.form.submit()" {% if all['body_content_editable'] %}checked{% endif %}>
						<label class="form-check-label" for="Content_editable">Content Editable</label>
					</form>
					{% if all['body_content_editable'] %} 
					<div class="form-text text-danger mt-1" style="font-size: 0.75rem;">
						<i class="fas fa-info-circle"></i> Turn off before leaving page.
					</div>
					{% else %} {% endif %}
				</div>
				<div class="features" id="EditContent">
					<form action="/Debug-mode" method="POST" id="debugModeForm" class="form-check form-switch bg-light border rounded p-2 ps-5">
						<input class="form-check-input" type="checkbox" role="switch" name="debugMode" id="debugging" onchange="this.form.submit()" {% if web.debugMode %}checked{% endif %}>
						<label class="form-check-label" for="debugging">Debug Mode</label>
					</form>
				</div>
				<div class="features" id="User Details">
					<p>
						<button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#adminDetailsCollapse" aria-expanded="false" aria-controls="adminDetailsCollapse">
							<i class="fas fa-user"></i> Your Details
						</button>
					</p>
					<div class="collapse" id="adminDetailsCollapse">
						<div class="card card-body">
							<form action="" method="post" enctype="multipart/form-data" >
								{% for detail in web.admin_details.items() %}
								<div class="input-group input-group-sm mb-3">
									<span class="input-group-text" id="inputGroup-sizing-sm">{{detail[0]}}</span>
									<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1" value="{{detail[1]}}">
								</div>
								{%endfor%}
								<button class="btn btn-outline-primary p-0 px-1">Save</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</section>
	</body>
</html>